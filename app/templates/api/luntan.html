<!-- templates/index.html -->
{% extends "nav.html" %}

{% block content %}
!DOCTYPE html>
<html>
<head>
    <title>{{ post.author.username }}çš„åŠ¨æ€</title>
</head>
<body>
    <div class="post-detail">
        <!-- å¸–å­å¤´éƒ¨ -->
        <div class="post-header">
            <img src="{{ post.author.avatar }}" class="avatar">
            <div class="post-info">
                <h1>{{ post.author.username }}</h1>
                <small>{{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
            </div>
        </div>

        <!-- å¸–å­å†…å®¹ -->
        <div class="content">
            {{ post.content }}
            {% if post.image %}
            <img src="{{ url_for('static', filename='uploads/' + post.image) }}" class="post-image">
            {% endif %}
        </div>

        <!-- äº’åŠ¨æŒ‰é’® -->
        <div class="post-actions">
            <form action="{{ url_for('like_post', post_id=post.id) }}" method="POST">
                <button type="submit" class="like-btn">
                    â¤ï¸ {{ post.likes|length }}
                </button>
            </form>
        </div>

        <!-- è¯„è®ºåŒº -->
        <div class="comments-section">
            <h3>è¯„è®ºï¼ˆ{{ post.comments|length }}ï¼‰</h3>
            
            <!-- è¯„è®ºåˆ—è¡¨ -->
            {% for comment in post.comments %}
            <div class="comment">
                <img src="{{ comment.author.avatar }}" class="avatar">
                <div class="comment-body">
                    <strong>{{ comment.author.username }}</strong>
                    <p>{{ comment.content }}</p>
                    <small>{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>
            </div>
            {% endfor %}

            <!-- è¯„è®ºè¡¨å• -->
            <form action="{{ url_for('add_comment', post_id=post.id) }}" method="POST">
                <textarea name="content" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." required></textarea>
                <button type="submit">å‘è¡¨è¯„è®º</button>
            </form>
        </div>
    </div>

    <!-- è¿”å›é“¾æ¥ -->
    <a href="{{ url_for('forum') }}">è¿”å›é¦–é¡µ</a>
</body>
</html>
<!-- å‘å¸–è¡¨å• -->
<div class="post-form-container">
    <form id="postForm" enctype="multipart/form-data">
        <textarea name="content" placeholder="å‘ä»€ä¹ˆåŠ¨æ€ï¼Ÿ" required></textarea>
        <input type="file" name="image" accept="image/*">
        <button type="submit">å‘å¸ƒåŠ¨æ€</button>
    </form>
</div>

<!-- å¸–å­åˆ—è¡¨å®¹å™¨ -->
<div id="postsContainer">
    {% for post in posts %}
    <div class="post" data-post-id="{{ post.id }}">
        <!-- å¸–å­å†…å®¹ -->
        <div class="post-content">
            <img src="{{ post.author.avatar }}" class="avatar">
            <div class="post-body">
                <h3>{{ post.author.username }}</h3>
                <p>{{ post.content }}</p>
                {% if post.image %}
                <img src="{{ url_for('static', filename='uploads/' + post.image) }}" class="post-image">
                {% endif %}
                <div class="post-meta">
                    <span class="like-count">{{ post.likes|length }}</span>
                    <button class="like-btn" data-post-id="{{ post.id }}">
                        {% if current_user.has_liked_post(post) %}â¤ï¸{% else %}ğŸ¤{% endif %}
                    </button>
                </div>
            </div>
        </div>

        <!-- è¯„è®ºåŒº -->
        <div class="comments-section">
            {% for comment in post.comments %}
            <div class="comment" data-comment-id="{{ comment.id }}">
                <img src="{{ comment.author.avatar }}" class="avatar">
                <div class="comment-body">
                    <h4>{{ comment.author.username }}</h4>
                    <p>{{ comment.content }}</p>
                </div>
            </div>
            {% endfor %}

            <!-- è¯„è®ºè¡¨å• -->
            <form class="comment-form" data-post-id="{{ post.id }}">
                <textarea name="content" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." required></textarea>
                <button type="submit">å‘é€</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>

<!-- åˆ†é¡µ -->
<div class="pagination">
    {{ pagination.links }}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // å¤„ç†å‘å¸–
        document.getElementById('postForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/api/create_post', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const newPost = await response.json();
                    appendNewPost(newPost);
                    this.reset();
                }
            } catch (error) {
                console.error('å‘å¸–å¤±è´¥:', error);
            }
        });
    
        // å¤„ç†ç‚¹èµ
        document.addEventListener('click', async function(e) {
            if (e.target.classList.contains('like-btn')) {
                const postId = e.target.dataset.postId;
                const likeButton = e.target;
                
                try {
                    const response = await fetch(`/api/like/${postId}`, {
                        method: 'POST',
                        credentials: 'same-origin'
                    });
                    
                    const data = await response.json();
                    updateLikeStatus(likeButton, data);
                } catch (error) {
                    console.error('ç‚¹èµå¤±è´¥:', error);
                }
            }
        });
    
        // å¤„ç†è¯„è®º
        document.addEventListener('submit', async function(e) {
            if (e.target.classList.contains('comment-form')) {
                e.preventDefault();
                const postId = e.target.dataset.postId;
                const formData = new FormData(e.target);
                
                try {
                    const response = await fetch(`/api/comment/${postId}`, {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        loadComments(postId);
                    }
                } catch (error) {
                    console.error('è¯„è®ºå¤±è´¥:', error);
                }
            }
        });
    });
    
    // æ›´æ–°ç‚¹èµçŠ¶æ€
    function updateLikeStatus(button, data) {
        button.textContent = data.liked ? 'â¤ï¸' : 'ğŸ¤';
        button.dataset.count = data.count;
    }
    
    // è¿½åŠ æ–°å¸–å­
    function appendNewPost(post) {
        const container = document.getElementById('postsContainer');
        const newPostElement = createPostElement(post); // éœ€è¦å®ç°è¿™ä¸ªå‡½æ•°
        container.prepend(newPostElement);
    }</script>
{% endblock %}